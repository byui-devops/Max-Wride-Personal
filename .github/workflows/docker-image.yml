name: CI/CD Pipeline (Test, Coverage, Docker Deploy)


# Triggers the workflow on pushes to the 'main' branch, or
# when a pull request targeting 'main' is opened, synchronized, or closed (merged).
on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize, closed ]
    branches: [ main ]


env:
  # Define the Docker image name prefix using the Docker Hub username and a repository name
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/bulletin-board-app
  # Use a consistent Node.js version as requested
  NODE_VERSION: '20'


jobs:
  test_and_deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: bulletin-board-app
   
    steps:
      # Step 1: Checkout the code from the repository
      - name: Checkout repository
        uses: actions/checkout@v4


      # Step 2: Set up Node.js environment
      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Step 3: Install dependencies
      # Using 'npm ci' (clean install) is faster and ensures deterministic installs
      # based on package-lock.json, which is standard CI/CD practice.
      - name: Install dependencies
        run: npm ci


      # Step 4: Run unit tests
      - name: Run tests
        run: npm run test


      # Step 5: Run test coverage check
      - name: Run test coverage
        run: npm run test:coverage


      # --- Deployment Steps (Only runs on a successful push/merge to the 'main' branch) ---
     
      # We ensure these steps only execute when the event is a 'push' to 'main'
      - name: Check if running on main push for deployment
        id: check_main_push
        run: echo "IS_MAIN_PUSH=${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}" >> $GITHUB_ENV


      - name: Skip Docker steps if not on main push
        if: env.IS_MAIN_PUSH == 'false'
        run: echo "Skipping Docker build/deploy steps as this is a PR or push to a non-main branch."
       
      - name: Set up Docker Buildx
        if: env.IS_MAIN_PUSH == 'true'
        uses: docker/setup-buildx-action@v3
               
      # Step 6: Log in to Docker Hub (Required for pushing images)
      - name: Login to Docker Hub
        if: env.IS_MAIN_PUSH == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          # Use a Docker Access Token as the password for security
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}


      # Step 7: Build and push the Docker image
      - name: Build and push Docker image
        if: env.IS_MAIN_PUSH == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:latest
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
